# .github/workflows/your-workflow-file.yml

name: Data Pipeline CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  pipeline-check:
    runs-on: ubuntu-latest
    timeout-minutes: 20 # Add timeout to prevent hanging

    services:
      # ... (mysql service configuration remains the same) ...
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: rootpass
          MYSQL_DATABASE: ds_project
          MYSQL_USER: ds_user
          MYSQL_PASSWORD: userpass
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    env:
      DB_HOST: 127.0.0.1
      DB_PORT: 3306
      DB_USER: ds_user
      DB_PASSWORD: userpass
      DB_NAME: ds_project

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          lfs: true # <-- ADD THIS LINE

      - name: Set up Python 3.12
        uses: actions/setup-python@v3
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: pip install --upgrade pip && pip install -r requirements.txt

      - name: Wait for MySQL to be ready
        run: |
          for i in {30..0}; do
            if mysql -h 127.0.0.1 -u root -prootpass -e 'SELECT 1' ds_project &> /dev/null; then
              echo "MySQL is ready"
              break
            fi
            echo "Waiting for MySQL... ($i seconds left)"
            sleep 1
          done
          if [ "$i" = 0 ]; then
            echo "MySQL failed to start"
            exit 1
          fi

      - name: Import database schema
        run: mysql -h 127.0.0.1 -u root -prootpass ds_project < database/schema.sql

      # ---- THIS IS THE NEW STEP ----
      - name: Seed database from CSV files
        run: python scripts/seed_database.py
      # ----------------------------

      - name: Run data pipeline
        run: |
          echo "ðŸš€ Starting data pipeline..."
          timeout 90m python pipeline.py || {
            echo "âŒ Pipeline failed or timed out"
            exit 1
          }
          echo "âœ… Pipeline completed successfully"
